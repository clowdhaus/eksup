
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="EKS Cluster Upgrade Guidance">
      
      
        <meta name="author" content="ClowdHaus">
      
      
      <link rel="icon" href="../imgs/favicon.ico">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.13">
    
    
      
        <title>Scratch - EKS Cluster Upgrade Guidance</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e411adfe.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cc9b2e1e.min.css">
        
          
          
          <meta name="theme-color" content="#ffa724">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=ember:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"ember";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="orange" data-md-color-accent="deep-orange">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#todo" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="EKS Cluster Upgrade Guidance" class="md-header__button md-logo" aria-label="EKS Cluster Upgrade Guidance" data-md-component="logo">
      
  <img src="../imgs/favicon.ico" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EKS Cluster Upgrade Guidance
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Scratch
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/clowdhaus/eksup" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    clowdhaus/eksup
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../process/" class="md-tabs__link">
        Process
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../design/overview/" class="md-tabs__link">
        Design
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="EKS Cluster Upgrade Guidance" class="md-nav__button md-logo" aria-label="EKS Cluster Upgrade Guidance" data-md-component="logo">
      
  <img src="../imgs/favicon.ico" alt="logo">

    </a>
    EKS Cluster Upgrade Guidance
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/clowdhaus/eksup" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    clowdhaus/eksup
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Process
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Process" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Process
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../process/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../process/commands/" class="md-nav__link">
        Commands
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../process/checks/" class="md-nav__link">
        Checks
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Design
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Design" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Design
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../design/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#todo" class="md-nav__link">
    🚧 ToDo 🚧
  </a>
  
    <nav class="md-nav" aria-label="🚧 ToDo 🚧">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#amazon-eks" class="md-nav__link">
    Amazon EKS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-highly-available" class="md-nav__link">
    Kubernetes Highly Available
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-deprecations" class="md-nav__link">
    Kubernetes Deprecations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-considerations" class="md-nav__link">
    Future Considerations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    Notes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#questions" class="md-nav__link">
    Questions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-upcoming-features" class="md-nav__link">
    Kubernetes Upcoming Features
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#misc" class="md-nav__link">
    Misc
  </a>
  
    <nav class="md-nav" aria-label="Misc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-plane-pre-upgrade" class="md-nav__link">
    Data Plane Pre-Upgrade
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/clowdhaus/eksup/tree/main/docs/scratch.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>Scratch</h1>

<p>A check must be able to answer <code>yes</code> to one of the following questions, depending on the type of check:</p>
<ul>
<li>Required: It will adversely affect the cluster and/or the services/applications running on the cluster during an upgrade</li>
<li>Recommended: It *has the potential to affect the cluster and/or the services/applications running on the cluster during an upgrade</li>
</ul>
<h2 id="todo">🚧 ToDo 🚧<a class="headerlink" href="#todo" title="Permanent link">&para;</a></h2>
<ul>
<li>[ ] Add summary at top of results shown to user for stdout and playbook
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Checks: 31 (Failed: 14, Excluded: 0, Skipped: 0)
</code></pre></div></li>
<li>[x] [<code>K8S001</code>] Version skew between control plane and data plane should adhere to skew policy</li>
</ul>
<h3 id="amazon-eks">Amazon EKS<a class="headerlink" href="#amazon-eks" title="Permanent link">&para;</a></h3>
<ul>
<li>[x] [<code>EKS001</code>] There are at least 5 free IPs in control plane subnets</li>
<li>[ ] [<code>AWS001</code>] Report on number of free IPs in data plane subnets<ul>
<li>TBD: should this be reported per MNG/ASG/profile, as a whole (data plane), or both?</li>
</ul>
</li>
<li>[x] [<code>AWS002</code>] Report on number of free IPs used by the pods when using custom networking</li>
<li>[x] [<code>EKS002</code>] Control plane is free of health issues</li>
<li>[x] [<code>EKS003</code>] EKS managed node group(s) are free of health issues</li>
<li>[x] [<code>EKS004</code>] EKS addon(s) are free of health issues</li>
<li>[x] [<code>EKS005</code>] EKS addon version is within supported range; recommend upgrading if target Kubernetes version default addon version is newer</li>
<li>[x] [<code>EKS006</code>] EKS managed node group(s): report if the launch template version is not the latest</li>
<li>[x] [<code>EKS007</code>] Self-managed node group(s): report if the launch template version is not the latest</li>
<li>[ ] Check AWS service limits and utilization for relevant resources</li>
<li>Requires premium support https://docs.aws.amazon.com/awssupport/latest/user/service-limits.html</li>
<li>[ ] [<code>AWS003</code>] EC2 instance service limits<ul>
<li><code>aws support describe-trusted-advisor-check-result --check-id 0Xc6LMYG8P</code></li>
</ul>
</li>
<li>[ ] EBS volume service limits<ul>
<li>[ ] [<code>AWS004</code>] GP2 <code>aws support describe-trusted-advisor-check-result --check-id dH7RR0l6J9</code></li>
<li>[ ] [<code>AWS005</code>] GP3 <code>aws support describe-trusted-advisor-check-result --check-id dH7RR0l6J3</code></li>
</ul>
</li>
</ul>
<h3 id="kubernetes-highly-available">Kubernetes Highly Available<a class="headerlink" href="#kubernetes-highly-available" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th align="center">Check</th>
<th align="center">Deployment</th>
<th align="center">ReplicaSet</th>
<th align="center">ReplicationController</th>
<th align="center">StatefulSet</th>
<th align="center">Job</th>
<th align="center">CronJob</th>
<th align="center">Daemonset</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">[<code>K8S001</code>]</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">[<code>K8S002</code>]</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr>
<td align="center">[<code>K8S003</code>]</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr>
<td align="center">[<code>K8S004</code>]</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr>
<td align="center">[<code>K8S005</code>]</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr>
<td align="center">[<code>K8S006</code>]</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr>
<td align="center">[<code>K8S007</code>]</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr>
<td align="center">[<code>K8S008</code>]</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
</tr>
<tr>
<td align="center">[<code>K8S009</code>]</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">[<code>K8S010</code>]</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
</tbody>
</table>
<ul>
<li>[x] [<code>K8S002</code>] <code>.spec.replicas</code> set &gt;= 3</li>
<li>[x] [<code>K8S003</code>] <code>.spec.minReadySeconds</code> set &gt; 0 - https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-probes</li>
<li>[ ] [<code>K8S004</code>] <code>podDisruptionBudgets</code> set &amp; at least one of <code>minAvailable</code> or <code>maxUnavailable</code> is set</li>
<li>[ ] [<code>K8S005</code>] Either <code>.spec.affinity.podAntiAffinity</code> or <code>.spec.topologySpreadConstraints</code> set to avoid multiple pods from being scheduled on the same node. https://kubernetes.io/docs/concepts/configuration/assign-pod-node/</li>
<li>[ ] Prefer topology hints over affinity <code>Note: Inter-pod affinity and anti-affinity require substantial amount of processing which can slow down scheduling in large clusters significantly. We do not recommend using them in clusters larger than several hundred nodes.</code> https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity</li>
<li>[ ] [<code>K8S006</code>] <code>.spec.containers[*].readinessProbe</code> set</li>
<li>[ ] <code>.spec.containers[*].livenessProbe</code> , if set, is NOT the same as <code>.spec.containers[*].readinessProbe</code></li>
<li>[ ] <code>.spec.containers[*].startupProbe</code> is set if <code>.spec.containers[*].livenessProbe</code> is set</li>
<li>[ ] [<code>K8S007</code>] <code>pod.Spec.TerminationGracePeriodSeconds</code> &gt; 0 - The StatefulSet should not specify a pod.Spec.TerminationGracePeriodSeconds of 0 https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#deployment-and-scaling-guarantees</li>
<li>(StatefulSet)</li>
</ul>
<h3 id="kubernetes-deprecations">Kubernetes Deprecations<a class="headerlink" href="#kubernetes-deprecations" title="Permanent link">&para;</a></h3>
<p>Note: the Kubernetes version these apply to will need to be taken into consideration to avoid telling users about checks that do not apply to their version.</p>
<ul>
<li>[ ] [<code>K8S008</code>] Detect docker socket use (1.24+ affected) https://github.com/aws-containers/kubectl-detector-for-docker-socket</li>
<li>[ ] [<code>K8S009</code>] Warn on pod security policy use (deprecated 1.21, removed 1.25) https://kubernetes.io/docs/concepts/security/pod-security-policy/</li>
<li>[ ] Advise to switch to pod security admission https://kubernetes.io/docs/concepts/security/pod-security-admission/</li>
<li>[ ] [<code>K8S010</code>] In-tree to CSI migration https://kubernetes.io/blog/2021/12/10/storage-in-tree-to-csi-migration-status-update/ ?</li>
<li>[ ] The <a href="https://kubernetes.io/docs/concepts/storage/volumes/#awselasticblockstore">in-tree Amazon EBS storage provisioner</a> is deprecated. If you are upgrading your cluster to version 1.23, then you must first install the Amazon EBS driver before updating your cluster. For more information, see <a href="https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi-migration-faq.html">Amazon EBS CSI migration frequently asked questions</a>. If you have pods running on a version 1.22 or earlier cluster, then you must install the Amazon EBS driver before updating your cluster to version 1.23 to avoid service interruption. https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi-migration-faq.html</li>
<li>Blog https://aws.amazon.com/blogs/containers/migrating-amazon-eks-clusters-from-gp2-to-gp3-ebs-volumes/</li>
</ul>
<h3 id="future-considerations">Future Considerations<a class="headerlink" href="#future-considerations" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] APIs deprecated and/or removed in the next Kubernetes version</li>
<li>For now, <code>pluto</code> or <code>kubent</code> are recommended to check for deprecated APIs</li>
<li>Add section on how those tools work, what to watch out for (asking the API Server is not trustworthy, scanning manifests directly is the most accurate)</li>
<li>Look into using the <code>apiserve_requested_deprecated_apis</code> metric to detect usage of deprecated APIs<ul>
<li>https://kubernetes.io/blog/2020/09/03/warnings/</li>
<li>https://github.com/kubernetes/enhancements/tree/master/keps/sig-api-machinery/1693-warnings</li>
<li>https://github.com/kube-rs/kube/issues/492 for implementation</li>
</ul>
</li>
<li>[ ] Add image and chart for running <code>eksup</code> on the cluster in a continuous fashion (CronJob)</li>
<li>Send results to a central location like S3 for centralized aggregation and reporting across a fleet of clusters</li>
<li>[ ] Add support to output results in JSON and CSV formats</li>
<li>Multi-cluster scenario - all clusters emitting data back to central location to report on which clusters need components to be upgraded/modified</li>
<li>Can utilize an Athena table to aggregate and summarize data</li>
<li>[ ] Configuration file to allow users more control over what checks they want to opt in/out of, the values of those checks, etc.</li>
<li>[ ] Progress indicator https://github.com/console-rs/indicatif</li>
<li>[ ] Ability to convert from one resource API version to another (where possible)</li>
<li><code>migrate</code> or <code>transform</code></li>
<li>Given a manifest, convert the manifest to the next, stable API version. Some resources only need the API version changed, others will require the schema to be modified to match the new API version</li>
<li>[ ] Add snippets/information for commonly used provisioning tools to explain how those fit into the guidance</li>
<li><code>terraform-aws-eks</code>/<code>eksctl</code> - how to upgrade a cluster with these tools, what will they do for the user (ensure addon versions are aligned with the Kubernetes version, the ordering of upgrade steps, etc.)</li>
<li>[ ] Configure output levels</li>
<li><code>--quiet</code> - suppress all output</li>
<li>(default, no flags) - show failed checks on hard requirements</li>
<li><code>--warn</code> - in addition to failed, show warnings (low number of IPs available for nodes/pods, addon version older than current default, etc.)</li>
<li><code>--info</code> - in addition to failed and warnings, show informational notices (number of IPs available for nodes/pods, addon version relative to current default and latest, etc.)</li>
</ul>
<h2 id="notes">Notes<a class="headerlink" href="#notes" title="Permanent link">&para;</a></h2>
<ul>
<li>Prefer topology hints over affinity for larger clusters</li>
<li><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity">Inter-pod affinity and anti-affinity</a>
    &gt; Note: Inter-pod affinity and anti-affinity require substantial amount of processing which can slow down scheduling in large clusters significantly. We do not recommend using them in clusters larger than several hundred nodes.</li>
</ul>
<h2 id="questions">Questions<a class="headerlink" href="#questions" title="Permanent link">&para;</a></h2>
<ul>
<li>What is the guidance for batch workloads?</li>
<li>Recommend creating a maintenance window where workloads should avoid being scheduled?</li>
<li><code>JobFailurePolicy</code> coming in in 1.26 https://kubernetes.io/docs/concepts/workloads/controllers/job/#pod-failure-policy</li>
<li>What is the recommended way to manage the lifecycle of Fargate pods?</li>
<li>After the control plane Kubernetes version has been upgraded, what is the best approach to "roll" the pods in order to pull fresh pods/nodes with the new K8s version?</li>
<li>Use a mutating webhook to inject <code>nodeSelector: failure-domain.beta.kubernetes.io/zone: &lt;AZ&gt;</code> into pods created to distribute across the AZs. (EKS Fargate does not natively do this today - see https://github.com/aws/containers-roadmap/issues/824)</li>
<li>What is the churn calculation for updating node groups?</li>
<li>What is the surge calculation - I thought I saw it was <code>2 * max(min-size, desired-size)</code> somewhere?</li>
<li>For EKS MNG, the surge limit is capped at 100 nodes - should this be applied to self-managed node groups as well, and if so, how?</li>
<li>This is important for:<ul>
<li>Do users have enough resources at their disposal before the start their upgrade or do they need to request resource limit increases (EC2s)?</li>
<li>How does the number of available IPs affect this process? If a customer knows they only have <code>x</code> available IPs in the data plane (say 100), can we provide a calculation that helps them configure their update settings to avoid errors and exhausting IPs while upgrading?</li>
<li>How long will the upgrade take users?</li>
<li>How can users influence the amount of churn - why should they, what recommendations or guidance do we have?</li>
</ul>
</li>
<li>Do we have different guidance for large clusters?</li>
<li>See note on <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity">Inter-pod affinity and anti-affinity</a></li>
</ul>
<h2 id="kubernetes-upcoming-features">Kubernetes Upcoming Features<a class="headerlink" href="#kubernetes-upcoming-features" title="Permanent link">&para;</a></h2>
<p>Relevant features that are coming in future releases of Kubernetes. A feature is "relevant" in in this context if it is something that would be checked and reported on by <code>eksup</code> to aid in upgrades:</p>
<ul>
<li><code>.spec.updateStrategy.rollingUpdate.maxUnavailable</code> for StatefulSets <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#maximum-unavailable-pods"><code>Kubernetes v1.24 [alpha]</code></a></li>
<li>Recommend that a value is set on all StatefulSets</li>
<li><code>PodDisruptionCondition</code> for PodDisruptionBudgets <a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/#pod-disruption-conditions"><code>Kubernetes v1.26 [beta]</code></a></li>
<li>See recommendation below for <code>podFailurePolicy</code></li>
<li><code>.spec.podFailurePolicy</code> for Jobs/CronJobs <a href="https://kubernetes.io/docs/concepts/workloads/controllers/job/#pod-failure-policy"><code>Kubernetes v1.26 [beta]</code></a></li>
<li>Recommend to <code>Ignore</code> conditions caused by preemption, API-initiated eviction, or taint-based eviction so that upgrade type evictions do not count against <code>.spec.backoffLimit</code> and the jobs will be re-tried. Note - <code>.spec.restartPolicy</code> will need to be set to <code>Never</code> and <code>PodDisruptionCondition</code> must be set for PodDisruptionBudgets</li>
</ul>
<h2 id="misc">Misc<a class="headerlink" href="#misc" title="Permanent link">&para;</a></h2>
<ul>
<li>Update strategies should be reviewed for 3rd party addons. For example, once the cluster is upgrade, users should review the other addons/controllers/operators running on the cluster and update if necessary. While not directly tied to the cluster upgrade itself, its important to at least inform that this is a recommended practice for users to follow to avoid downtimes when upgrading those components following a cluster upgrade.</li>
<li><code>.spec.strategy.type</code> != <code>Recreate</code> - https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rolling-update-deployment<ul>
<li>(Deployment, ReplicaSet) - excludes ReplicationController which recommends blue/green upgrade</li>
<li>[ ] <code>.spec.strategy.rollingUpdate.maxUnavailable</code> is set (Recommended)</li>
<li>[ ] <code>.spec.strategy.rollingUpdate.maxSurge</code> is set (Recommended)</li>
</ul>
</li>
<li>[ ] <code>.spec.updateStrategy.type</code> != <code>OnDelete</code> - https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#rolling-updates<ul>
<li>(StatefulSet)</li>
</ul>
</li>
</ul>
<h3 id="data-plane-pre-upgrade">Data Plane Pre-Upgrade<a class="headerlink" href="#data-plane-pre-upgrade" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>We strongly recommend that you have <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#configure-probes">readiness and liveness probes</a> configured before upgrading the data plane. This ensures that your pods register as ready/healthy at the appropriate time during an upgrade.</p>
<ul>
<li>For stateful workloads<ul>
<li>ℹ️ <a href="https://www.velotio.com/engineering-blog/exploring-upgrade-strategies-for-stateful-sets-in-kubernetes">Exploring Upgrade Strategies for Stateful Sets in Kubernetes</a></li>
<li>⚠️ TODO - what guidance for cluster backup before upgrade<ul>
<li><a href="https://github.com/vmware-tanzu/velero-plugin-for-aws">Velero</a></li>
<li><a href="https://github.com/portworx/aws-helm/tree/master/portworx">Portworx</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#maximum-unavailable-pods">1.24+ only - maximum unavailable pods</a></li>
</ul>
</li>
<li>If your stateful set does not require unique ordering, typically associated with processes that utilize leader election, switching to a <code>parallel</code> strategy for <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#parallel-pod-management"><code>podManagementPolicy</code></a> will speed up your scale up/down time as well as reduce the time needed to upgrade your cluster.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>If you are running a critical application on a Karpenter-provisioned node, such as a long running batch job or stateful application, and the node’s TTL has expired, the application will be interrupted when the instance is terminated. By adding a karpenter.sh/do-not-evict annotation to the pod, you are instructing Karpenter to preserve the node until the Pod is terminated or the do-not-evict annotation is removed. See Deprovisioning documentation for further information.</p>
</li>
</ul>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; ClowdHaus 2023
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.tabs.sticky"], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ed9748b7.min.js"></script>
      
    
  </body>
</html>